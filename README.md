# devops-prow
Prow is a kubernetes based ci/cd tool. For more go to this link https://github.com/kubernetes/test-infra/blob/master/prow/getting_started_deploy.md
## How to deploy Prow ?
Before deploing Prow, ensure that you have created access token in Github. Go to Profile Settings -> Developer settings -> Personal access token and check the boxes: admin:org, admin:org_hook, admin:repo_hook, repo. After that access token will be generated. Copy the new token an save it somewhere because it will be necessary later. In addition, to talk with Github you will need another token which is hmac-token. hmac-token is the token that you give to Github for validating webhooks. Genarate it using any randomness-generator. For example,
```bash
openssl rand -hex 20 > /path/to/hook/secret  
```
In aws/secrets you can find two json files related to github token. Insert personal access and hmac tokens to corresponding files `github-access-token.json` and `github-hmac-token.json`. To clone private repo you need to create ssh key and save to `ssh-secret.json`. Note that you should paste all content of your ssh key from "-----BEGIN RSA PRIVATE KEY-----" till "-----END RSA PRIVATE KEY-----". As an example take a look to current ssh-secret.json file.

As previously mentioned that prow has microservice architecture. That's why it has several components that must be deployed. To configure all of these components prow has a `config.yaml` file in the kubernetes/clusters folder. The main part in this file is a `tide` configuration. You should specify repos that are related to clusters. As a storage for prow logs we use S3 bucket in each cluster. Before storing in the bucket we created a user `prow` with permission to S3 service and store user's credentials such as `access_key` and `secret_key` in aws/secrets/clusters/cluster_name/s3-credentials.json. However, there might be another way to persist logs s3 like using a role. Unfortunately, I don't have enough time to research on it. After the secret's creation we should specify the secret name in `config.yaml` file. Moreover, in the `config.yaml` file we can describe periodic jobs, which will run at specified time.

To triger any jobs we should do two steps: add a webhook to github, and define a jobs that will be triggered after github events like push. You must be an admin to have a permission to add any webhooks to repo. In repo go to Settings -> Webhooks and generate them. Paste a DNS name of prow, change content type to `application/json` paste hmac-token and select `Send me everything`. Wait until green tick will appear near your generated token. After that go to a repo and add `.prow.yaml` file. This file describes the jobs on what condition prow would start a build. Note: to clone any private repo we have to add paramaters like: clone_uri, ssh_secrets_key. For more info about job's definition click on this link https://github.com/kubernetes/test-infra/blob/master/config/jobs/README.md 

Prow has the `tide` component, which are used for managing a pool of github's PRs that match a given set of criteria. Tide is able to retest and merge PRs. To met tide's criteria in the `config.yaml` file add labels in a `query` parameter by which tide will check PRs. To use specified labels we have to install plagins. You can check it in `plagins.yaml` file. Note: now, only a `lgtm` label works. I have tried with a `approved` label but it was unsuccessful. However, there is an example https://raw.githubusercontent.com/falcosecurity/test-infra/master/config/plugins.yaml, where other users have configured plagins. Maybe you should look on it to configure plagins.

Now instead of using additional container to build docker image like in jenkins, prow uses a preset and script. The script name is `tron-prow-runner

